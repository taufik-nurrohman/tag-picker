/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).TagPicker=e()}(this,(function(){"use strict";var t=function(t){return Array.isArray(t)},e=function(t){return"function"==typeof t},n=function(t,e){return t&&r(e)&&t instanceof e},s=function(t,e){return void 0===e&&(e=!0),"object"==typeof t&&(!e||n(t,Object))},r=function(t){return function(t){return void 0!==t}(t)&&!function(t){return null===t}(t)},u=function(t){return"string"==typeof t},o=function(t){return t.toLowerCase()},i=function(t){return t.length},a=function(t){return Object.keys(t)},c=function(t){return Object.values(t)},f=function e(){for(var n=arguments.length,u=Array(n),o=0;o<n;o++)u[o]=arguments[o];for(var a,c=u.shift(),f=0,l=i(u);f<l;++f)for(var v in u[f])if(r(c[v]))if(t(c[v])&&t(u[f][v])){c[v]=[].concat(c[v]);for(var p=0,h=i(u[f][v]);p<h;++p)a=u[f][v][p],-1===c[v].indexOf(a)&&c[v].push(u[f][v][p])}else s(c[v])&&s(u[f][v])?c[v]=e({},c[v],u[f][v]):c[v]=u[f][v];else c[v]=u[f][v];return c},l=function e(n){if(t(n))return n.map((function(t){return e(n)}));if(s(n)){for(var r in n)n[r]=e(n[r]);return n}return!1===n?"false":null===n?"null":!0===n?"true":""+n},v=document,p=window,h=function(t,e){return t["next"+(e?"":"Element")+"Sibling"]||null},_=function(t,e){return e?t.closest(e)||null:t.parentNode||null},m=function(t){var e="form";return k(t,e)&&e===function(t){return o(t&&t.nodeName||"")||null}(t[e])?t[e]:_(t,e)},d=function(t,e){void 0===e&&(e=!0);var n="textContent";if(!k(t,n))return!1;var s=t[n];return""!==(s=e?s.trim():s)?s:null},g=function(t,e){return t.classList.contains(e)},k=function(t,e){return e in t},y=function(t,e){return t.removeAttribute(e),t},b=function(t,e){return t.classList.remove(e),t},x=function(t){var e=_(t);return t.remove(),e},w=function(t,e,n){return!0===n&&(n=e),t.setAttribute(e,l(n)),t},j=function(t,e){return t.append(e),e},E=function(t,e){return t.classList.add(e),t},A=function(t,e,n){return t=u(t)?v.createElement(t):t,s(e)&&(n=e,e=!1),u(e)&&L(t,e),s(n)&&function(t,e){var n;for(var s in e)(n=e[s])||""===n||0===n?w(t,s,n):y(t,s)}(t,n),t},L=function(t,e,n){if(void 0===n&&(n=!0),null===e)return t;var s="innerHTML";return k(t,s)&&(t[s]=n?e.trim():e),t},S=function(t,e,n){if(void 0===n&&(n=!0),null===e)return t;var s="textContent";return k(t,s)&&(t[s]=n?e.trim():e),t};var K=function(t,e,n){e.removeEventListener(t,n)},R=function(t){return t&&t.preventDefault()},C=function(t,e,n,s){void 0===s&&(s=!1),e.addEventListener(t,n,s)},T=function(t,e){return function(t){return n(t,RegExp)}(t)?t:RegExp(t,r(e)?e:"g")},O="ArrowLeft",q="ArrowRight",P="Home",B="Backspace",N="End",D={focusVisible:!0},H="TagPicker";function I(t,e,n){Object.defineProperty(t,e,n)}function M(t,e){return p.setTimeout(t,1)}function V(t){return t.disabled}function W(t){var e,n=v.createRange();n.selectNodeContents(t),n.collapse(!1),(e=p.getSelection()).removeAllRanges(),e.addRange(n)}function Z(t,e){var s=this;return t?n(s,Z)?(t["_"+H]=function(t,e){return(e=e||t).fire=function(t,e){var n=this,s=n.hooks;return r(s[t])?(s[t].forEach((function(t){return t.apply(n,e)})),n):n},e.off=function(t,e){var n=this,s=n.hooks;if(!r(t))return s={},n;if(r(s[t]))if(r(e)){var u=s[t].length;if(0===u)delete s[t];else for(var o=0;o<u;++o)if(e===s[t][o]){s[t].splice(o,1);break}}else delete s[t];return n},e.on=function(t,e){var n=this.hooks;return r(n[t])||(n[t]=[]),r(e)&&n[t].push(e),this},t.hooks={},t}(s,Z.prototype),s.attach(t,f({},Z.state,u(e)?{join:e}:e||{}))):new Z(t,e):s}Z.state={class:"tag-picker",escape:[","],join:", ",max:9999,min:0,pattern:null,with:[]},Z.version="4.0.0",I(Z,"name",{value:H});var $=Z.prototype;function z(){var t=this["_"+H].state;b(this,t.class+"--focus")}function F(){var t=this["_"+H];t._mask;var e=t.mask,n=t.state.class;b(e,n+="--focus"),b(e,n+="-tag")}function G(){var t=this["_"+H],e=t._mask,n=t.mask,s=t.state,r=e.text,u=s.class;b(r,u+"__text--focus"),b(n,u+="--focus"),b(n,u+="-text")}function J(t){var e=this["_"+H],n=e._mask,s=e._tags,r=e.mask,u=e.state,o=n.copy,a=u.class+"__tag--focus",c=[];for(var f in s)g(s[f],a)&&c.push(f);i(c)&&(r!==_(o)&&(o.value=c.join(u.join),j(r,o)),o.focus(),o.select())}function Q(){var t=this,e=t["_"+H];e._mask.input,M((function(){return x(t),e.focus()}))}function U(){var t=this,e=t["_"+H],n=e._mask,s=e.state;n.input,t.value.split(s.join).forEach((function(t){return e.let(t)})),M((function(){return x(t),e.focus()}))}function X(){var t=this["_"+H];t._tags;var e=t.mask,n=t.state.class;E(e,n+"--focus"),E(e,n+"--select")}function Y(){var t=this["_"+H],e=t._mask,n=t._tags,s=t.mask,r=t.self,u=t.state,o=e.copy,i=e.hint,a=e.input,c=e.text,f=u.class;for(var l in n)b(n[l],f+"__tag--focus");x(o),b(s,f+"--select"),E(c,f+"__text--focus"),E(s,f+="--focus"),E(s,f+="-text"),W(a),M((function(){return S(i,d(a)?"":r.placeholder)}))}function tt(){this["_"+H].focus()}function et(){var t=this["_"+H].state.class;E(this,t+"--focus")}function nt(){var t=this["_"+H];t._mask;var e=t.mask,n=t.state.class;E(e,n+="--focus"),E(e,n+="-tag")}I($,"text",{get:function(){return d(this._mask.input)},set:function(t){S(this._mask.input,t)}}),I($,"value",{get:function(){var t=this.self.value;return""===t?null:t},set:function(t){var e=this,n=e.state;t.split(n.join).forEach((function(t){return e.set(t)}))}}),$._filter=function(t){var e,n,s=this.state;return t=(t||"").split(s.join).join("").trim(),(e=t,void 0===n&&(n="-"),e.replace(/[A-Z]/g,(function(t){return n+o(t)})).replace(/\W+/g,n)).replace(/^-+|-+$/g,"")};var st=!1;function rt(t){var e=this["_"+H];e.mask,e.state.class,st=t.ctrlKey,t.shiftKey}function ut(t){var e,n,s,r=this,u=t.key,o=st=t.ctrlKey,i=t.shiftKey,a=r["_"+H],f=a._mask,l=a._tags,v=a.mask,p=a.state,_=f.copy,m=f.text,d=r.previousElementSibling||null,g=h(r),k=p.class+"__tag--focus";if(o){if(!i&&"a"===u){for(var y in l)E(l[y],k);_.value=a.value,j(v,_),_.focus(),_.select(),e=!0}}else i||b(r,k),P===u?((n=c(l).shift())&&n.focus(D),e=!0):N===u?((s=c(l).pop())&&s.focus(D),e=!0):O===u?(d&&d.focus(D),e=!0):q===u?(g&&m!==g?g.focus(D):a.focus(),e=!0):B===u?(a.let(r.title),d?d.focus(D):a.focus(),e=!0):"Delete"===u&&(a.let(r.title),g&&m!==g?g.focus(D):a.focus(),e=!0);e&&R(t)}function ot(t){var e=t.key,n=t.ctrlKey;t.shiftKey;var s=this["_"+H],r=s._mask,u=s._tags,o=s.state,i=r.copy;r.input;var a=o.class+"__tag--focus";function f(){for(var t in x(i),u)b(u[t],a)}n||(P===e||O===e?(f(),c(u).shift().focus(D)):N===e||q===e?(f(),c(u).pop().focus(D)):"Escape"===e?(f(),s.focus()):(this.value.split(o.join).forEach((function(t){return s.let(t)})),s.focus()))}function it(t){var n,s,r,u,o=this,i=t.key,a=t.keyCode,f=t.ctrlKey,l=t.shiftKey,h=o["_"+H],_=h._mask,g=h._tags,k=h.mask,y=h.self,b=h.state,x=_.copy,w=_.hint,A=b.class+"__tag--focus";if((escape=b.escape).includes(i)||escape.includes(a))return h.set(d(o)),S(o,""),S(w,y.placeholder),h.focus(),R(t);M((function(){return S(w,d(o)?"":y.placeholder)}));var L,K=""===function(t){var e,n=p.getSelection();if(n.rangeCount>0)return(e=n.getRangeAt(0).cloneRange()).collapse(!0),e.setStart(t,0),(e+"").slice(-1)}(o),C=null===d(o);if(P===i&&(f||C))(r=c(g).shift())&&r.focus(D),n=!0;else if(N===i&&(f||C))(u=c(g).pop())&&u.focus(D),n=!0;else if(O===i&&(f||K))(u=c(g).pop())&&u.focus(D),n=!0;else if(B===i&&C)(u=c(g).pop())&&h.let(u.title),h.focus(),n=!0;else if("Enter"===i){var T=m(y);if(T&&e(T.requestSubmit)){var q=(L="button:not([type]),button[type=submit],input[type=image],input[type=submit]",(T||v).querySelector(L));q?T.requestSubmit(q):T.requestSubmit()}n=!0}else if(f&&!l&&"a"===i&&null===d(o)&&null!==(s=h.value)){for(var I in g)E(g[I],A);x.value=s,j(k,x),x.focus(),x.select(),n=!0}n&&R(t)}function at(){var t=this["_"+H],e=t._mask,n=t._tags,s=t.mask,r=t.state,u=e.copy,o=r.class+"__tag--focus";st=!1;var a=[];for(var c in n)g(n[c],o)&&a.push(c);i(a)&&(u.value=a.join(r.join),j(s,u),u.focus(),u.select())}function ct(){var t=this,e=t.value,n=t["_"+H],s=n._mask,r=n.state,u=s.copy;s.input,M((function(){""!==e&&e.split(r.join).forEach((function(t){return n.let(t)})),""!==(e=t.value)&&e.split(r.join).forEach((function(t){return n.set(t)})),x(u),n.focus()}))}function ft(){var t=this,e=t["_"+H],n=e._mask,s=e.state,r=n.hint;M((function(){var n=d(t);null!==n&&n.split(s.join).forEach((function(t){return e.set(t)})),S(t,""),S(r,e.self.placeholder)}))}function lt(t){var e=this["_"+H],n=e._mask,s=e._tags,r=e.mask,u=e.state,o=n.copy,i=n.input,a=u.class+"__tag--focus";if(r===_(o))if(i===t.target){var c=0;for(var f in s)g(s[f],a)&&++c;c<2&&e.focus()}else o.focus(),o.select();else e.focus();R(t)}function vt(t){var e=this,n=e["_"+H],s=n._mask,r=n._tags,u=n.mask,o=n.state,i=s.copy,a=o.class+"__tag--focus";if(function(t,e,n){t.classList.toggle(e,n)}(e,a),st){var c=[];for(var f in r)g(r[f],a)&&c.push(f);i.value=c.join(o.join),i.focus(),i.select()}else{for(var l in r)e!==r[l]&&b(r[l],a);g(e,a)?(i.value=e.title,j(u,i),M((function(){return i.focus(),i.select()}))):x(i)}!function(t){t&&t.stopPropagation()}(t)}function pt(t){var e=_(this),n=e["_"+H];n._mask.input,K("click",this,pt),n.let(e.title),n.focus(),R(t)}return $.attach=function(n,o){var a=this;n=n||a.self,o=o||a.state,a._active=!0,a._tags={},a._value=function(t){return t.value.replace(/\r/g,"")}(n),a.self=n,a.state=o;var c=o.class,f="_"+H;m(n);var l=A("div",{class:c,tabindex:!V(n)&&-1});a.mask=l;var v,p,d=A("span",{class:c+"__tags"}),g=A("span",{class:c+"__text"}),k=A("input",{class:c+"__copy",tabindex:-1,type:"text"}),y=A("span",{contenteditable:!V(n)&&"true",spellcheck:"false",style:"white-space:pre;"}),b=A("span",n.placeholder+"");j(l,d),j(d,g),j(g,y),j(g,b),E(n,c+"__self"),p=l,_(v=n).insertBefore(p,h(v,!0)),C("blur",l,z),C("blur",y,G),C("contextmenu",l,J),C("copy",k,Q),C("cut",k,U),C("focus",l,et),C("focus",n,tt),C("focus",k,X),C("focus",y,Y),C("keydown",l,rt),C("keydown",k,ot),C("keydown",y,it),C("keyup",l,at),C("mousedown",l,lt),C("paste",k,ct),C("paste",y,ft),C("touchstart",l,lt),n.tabIndex=-1,l[f]=a,k[f]=a,y[f]=a;var x={};if(x.copy=k,x.hint=b,x.input=y,x.of=n,x.self=l,x.tags=d,x.text=g,a._mask=x,r(o)&&t(o.with))for(var w=0,L=i(o.with);w<L;++w){var S=o.with[w];u(S)&&(S=Z[S]),e(S)?S.call(a,n,o):s(S)&&e(S.attach)&&S.attach.call(a,n,o)}return a},$.blur=function(){},$.click=function(){},$.detach=function(){var n=this,r=n._mask,o=n.mask,a=n.self,c=n.state,f=r.copy,l=r.input;if(n._active=!1,K("blur",l,G),K("blur",o,z),K("contextmenu",o,J),K("copy",f,Q),K("cut",f,U),K("focus",f,X),K("focus",l,Y),K("focus",o,et),K("focus",a,tt),K("keydown",f,ot),K("keydown",l,it),K("keydown",o,rt),K("keydown",o,at),K("mousedown",o,lt),K("paste",f,ct),K("paste",l,ft),K("touchstart",o,lt),t(c.with))for(var v=0,p=i(c.with);v<p;++v){var h=c.with[v];u(h)&&(h=Z[h]),s(h)&&e(h.detach)&&h.detach.call(n,a,c)}return a.tabIndex=null,b(a,c.class+"__self"),x(o),n._mask={of:a},n.mask=null,n},$.focus=function(){var t=this._mask.input;return t&&t.focus(),W(t),this},$.get=function(t){var e=this._active,n=this._tags;return!!e&&(n[t]?t:null)},$.let=function(t){var e=this,n=e._active,s=e._tags,r=e.self,u=e.state;if(!n)return e;if(!s[t])return!1;var o=s[t],i=o.firstElementChild||null;return K("blur",o,F),K("focus",o,nt),K("keydown",o,ut),K("mousedown",o,vt),K("mousedown",i,pt),K("touchstart",o,vt),K("touchstart",i,pt),x(o),delete e._tags[t],r.value=a(e._tags).join(u.join),e},$.set=function(t){var n=this,s=n._active,r=n._filter,o=n._mask,i=n._tags,c=n.self,f=n.state,l=o.text,v=f.pattern,p=f.class;if(!s)return n;if(e(r)&&(t=r.call(n,t)),u(v)&&T(v)&&!T(v).test(t))return!1;if(""===t||i[t])return!1;var h,m,d=A("span",{class:p+="__tag",tabindex:-1,title:t}),g=A("span",{class:p+="-x",tabindex:-1});return C("blur",d,F),C("focus",d,nt),C("keydown",d,ut),C("mousedown",d,vt),C("mousedown",g,pt),C("touchstart",d,vt),C("touchstart",g,pt),d["_"+H]=n,j(d,g),m=d,_(h=l).insertBefore(m,h),n._tags[t]=d,c.value=a(n._tags).join(f.join),n},Z}));