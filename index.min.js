/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).TagPicker=e()}(this,(function(){"use strict";var t=function(t,e){return-1!==e.indexOf(t)},e=function(t){return Array.isArray(t)},n=function(t){return void 0!==t},r=function(t){return"function"==typeof t},i=function(t,e,n){return!(!t||"object"!=typeof t)&&(n?o(e)&&o(t.constructor)&&e===t.constructor:o(e)&&t instanceof e)},u=function(t){return"number"==typeof t},a=function(t,e){return void 0===e&&(e=!0),!(!t||"object"!=typeof t)&&(!e||i(t,Object,1))},o=function(t){return n(t)&&!function(t){return null===t}(t)},s=function(t){return"string"==typeof t},f=function(t){return t.length},c=function(t){if(e(t))return t.map((function(t){return c(t)}));if(function(t){return/^-?(?:\d*.)?\d+$/.test(t+"")}(t))return function(t,e){return void 0===e&&(e=10),e?parseInt(t,e):parseFloat(t)}(t);if(a(t)){for(var n in t)t[n]=c(t[n]);return t}return"false"!==t&&("null"===t?null:"true"===t||t)},l=function(){for(var n=arguments.length,r=Array(n),i=0;i<n;i++)r[i]=arguments[i];for(var u=r.shift(),s=0,c=f(r);s<c;++s)for(var v in r[s])if(o(u[v]))if(e(u[v])&&e(r[s][v])){u[v]=[].concat(u[v]);for(var p=0,h=f(r[s][v]);p<h;++p)t(r[s][v][p],u[v])||u[v].push(r[s][v][p])}else a(u[v])&&a(r[s][v])?u[v]=l({},u[v],r[s][v]):u[v]=r[s][v];else u[v]=r[s][v];return u},v=function(t){if(e(t))return t.map((function(e){return v(t)}));if(a(t)){for(var n in t)t[n]=v(t[n]);return t}return!1===t?"false":null===t?"null":!0===t?"true":""+t},p=document,h=window,_=function(t,e){return d(t,e||0)},g=function(t){return t.firstElementChild||null},d=function(t,e){var n=[].slice.call(t.children);return u(e)?n[e]||null:n},m=function(t,e,n){void 0===n&&(n=!0);var r=function(t,e,n){if(void 0===n&&(n=!0),!j(t,e))return null;var r=t.getAttribute(e);return n?c(r):r}(t,"data-"+e,n),i=(r+"").trim();return n&&i&&("["===i[0]&&"]"===i.slice(-1)||"{"===i[0]&&"}"===i.slice(-1))&&null!==(i=function(t){var e=null;try{e=JSON.parse(t)}catch(t){}return e}(r))?i:r},b=function(t,e){return t["next"+(e?"":"Element")+"Sibling"]||null},k=function(t,e){return e?t.closest(e)||null:t.parentNode||null},y=function(t){var e="form";return S(t,e)&&e===function(t){return(t&&t.nodeName||"").toLowerCase()||null}(t[e])?t[e]:k(t,e)},x=function(t,e){return t.previousElementSibling||null},w=function(t,e){void 0===e&&(e=!0);var n="textContent";if(!S(t,n))return!1;var r=t[n];return""!==(r=e?r.trim():r)?r:null},j=function(t,e){return t.hasAttribute(e)},E=function(t,e){return t.classList.contains(e)},S=function(t,e){return e in t},A=function(t,e){return t.removeAttribute(e),t},D=function(t,e){return t.classList.remove(e),t},T=function(t){var e=k(t);return t.remove(),e},C=function(t,e,n){return!0===n&&(n=e),t.setAttribute(e,v(n)),t},R=function(t,e){return t.append(e),e},L=function(t,e){return t.classList.add(e),t},q=function(t,e,n){return t=s(t)?p.createElement(t):t,a(e)&&(n=e,e=!1),s(e)&&N(t,e),a(n)&&function(t,e){var n;for(var r in e)(n=e[r])||""===n||0===n?C(t,r,n):A(t,r)}(t,n),t},N=function(t,e,n){if(void 0===n&&(n=!0),null===e)return t;var r="innerHTML";return S(t,r)&&(t[r]=n?e.trim():e),t},O=function(t,e){return k(t).insertBefore(e,t),e},z=function(t,e,n){if(void 0===n&&(n=!0),null===e)return t;var r="textContent";return S(t,r)&&(t[r]=n?e.trim():e),t},K=function(t,e,n){return t.classList.toggle(e,n),t},M=function(t,e){return function(){var n=arguments,r=this;setTimeout((function(){return t.apply(r,n)}),e)}};var P=function(t,e,n){e.removeEventListener(t,n)},B=function(t){return t&&t.preventDefault()},I=function(t,e,n,r){void 0===r&&(r=!1),e.addEventListener(t,n,r)},H=function(t,e){return function(t){return i(t,RegExp)}(t)?t:RegExp(t,o(e)?e:"g")},F="ArrowLeft",J="ArrowRight",W="Home",$="Backspace",G="End",Q="Enter",U=new WeakMap;function V(t,e,n){Object.defineProperty(t,e,n)}function X(t){t.focus()}function Y(t,e){t.forEach(e)}function Z(t,e){Y(t,e)}function tt(t){return rt(t,U)||null}function et(t){return m(t,"name")}function nt(t){return(t.value||"").replace(/\r/g,"")}function rt(t,e){return e.get(t)}function it(t,e){return e.has(t)}function ut(t){return t.disabled}function at(t){var e=p.getSelection();e.rangeCount&&e.removeRange(e.getRangeAt(0))}function ot(t,e){var n=p.getSelection();at();var r=p.createRange();r.selectNodeContents(t),n.addRange(r),1===e?n.collapseToEnd():-1===e&&n.collapseToStart()}function st(t,e){return ft(t,e,U)}function ft(t,e,n){return n.set(t,e)}function ct(t){var e=[];return Z(t,(function(t,n){return e.push(n)})),e}function lt(t){return pt(t).shift()}function vt(t){return pt(t).pop()}function pt(t){var e=[];return Z(t,(function(t){return e.push(t)})),e}function ht(t,e){var n=this;if(!t)return n;if(!i(n,ht))return new ht(t,e);st(t,function(t,e){return(e=e||t).fire=function(t,e,n){var r=this,i=r.hooks;return o(i[t])?(i[t].forEach((function(t){return t.apply(n||r,e)})),r):r},e.off=function(t,e){var n=this,r=n.hooks;if(!o(t))return r={},n;if(o(r[t]))if(o(e)){var i=r[t].length;if(0===i)delete r[t];else for(var u=0;u<i;++u)if(e===r[t][u]){r[t].splice(u,1);break}}else delete r[t];return n},e.on=function(t,e){var n=this.hooks;return o(n[t])||(n[t]=[]),o(e)&&n[t].push(e),this},t.hooks={},t}(n,ht.prototype));var r=l({},ht.state,s(e)?{join:e}:e||{});return a(e)&&e.escape&&(r.escape=e.escape),n.attach(t,r)}ht.from=function(t,e){return new ht(t,e)},ht.of=tt,ht.state={escape:[","],join:", ",max:1/0,min:0,n:"tag-picker",pattern:null,with:[]},ht.version="4.1.0",V(ht,"name",{value:"TagPicker"});var _t=ht.prototype;V(_t,"text",{get:function(){return w(this._mask.input)},set:function(t){var e=this._mask,n=this.self,r=e.hint,i=e.input;z(r,""===(t+="")?n.placeholder:""),z(i,t),ot(i)}}),V(_t,"value",{get:function(){var t=nt(this.self);return""===t?null:t},set:function(t){var e=this,n=e._event,r=e.state;e.value&&Y(e.value.split(r.join),(function(t){return e.let(t,1)})),Y(t.split(r.join),(function(t){return e.set(t,-1,1)})),e.fire("change",[n])}}),_t._convert=function(t){var e=this.state;return(t||"").replace(/[^ -~]/g," ").split(e.join).join("").replace(/\s+/g," ").trim()};var gt=!1,dt=!1;function mt(t){at();var e=tt(this);e._mask;var n=e._tags,r=e.mask,i=e.state.n;e._event=t,gt||dt||Z(n,(function(t){return D(t,i+"__tag--selected")})),D(r,i+="--focus"),D(r,i+="-tag")}function bt(t){at();var e=tt(this),n=e._mask,r=e.mask,i=e.state,u=n.text,a=i.n;e._event=t,D(u,a+"__text--focus"),D(r,a+="--focus"),D(r,a+="-text"),e.fire("blur",[t])}function kt(t){var e=tt(this),n=t.target,r=e.state.n+"__tag";e._event=t,E(n,r)||k(n,"."+r)||e.focus()}function yt(t){var e=this,n=tt(e),r=n.state.n+"__tag--selected";n._event=t,L(e,r),X(e),ot(g(e))}function xt(t){var e=tt(this),n=e._tags,r=e.state,i=r.n+"__tag--selected",u=[];e._event=t,Z(n,(function(t,e){E(t,i)&&u.push(e)})),t.clipboardData.setData("text/plain",u.join(r.join)),e.fire("copy",[t,u]).focus(),B(t)}function wt(t){var e=tt(this),n=e._mask,r=e._tags,i=e.state;n.input;var u=i.n+"__tag--selected",a=[];e._event=t,Z(r,(function(t,n){E(t,u)&&(a.push(n),e.let(n,1))})),t.clipboardData.setData("text/plain",a.join(i.join)),e.fire("cut",[t,a]).fire("change",[t,et(this)]).focus(),B(t)}function jt(t){var e=tt(this),n=e._mask,r=e._tags,i=e.mask,u=e.self,a=e.state,o=n.hint,s=n.input,f=n.text,c=a.n;e._event=t,Z(r,(function(t){return D(t,c+"__tag--selected")})),L(f,c+"__text--focus"),L(i,c+="--focus"),L(i,c+="-text"),M((function(){return z(o,w(s,!1)?"":u.placeholder)}),1)(),e.focus().fire("focus",[t])}function Et(t){var e=tt(this);e._event=t,e.focus()}function St(t){var e=tt(this);e._event=t,e.fire("min.tags",[t]).focus(),B(t)}function At(t){var e=tt(this);e._mask;var n=e.mask,r=e.state.n;e._event=t,L(n,r+="--focus"),L(n,r+="-tag"),e.fire("focus.tag",[t])}function Dt(t){var e,n=this,r=t.key,i=gt=t.ctrlKey,u=dt=t.shiftKey,a=tt(n),o=a._mask,s=a._tags;a.mask;var c,l,v,p=a.state,h=o.text,_=x(n),d=b(n),m=p.n+"__tag--selected";if(a._event=t,u)L(n,m),ot(g(n)),F===r?(_&&(E(_,m)?D(n,m):L(_,m),X(_),ot(g(_))),e=!0):J===r&&(d&&h!==d&&(E(d,m)?D(n,m):L(d,m),X(d),ot(g(d))),e=!0);else if(i)"a"===r?(Z(s,(function(t){X(t),ot(g(t)),L(t,m)})),e=!0):F===r?(_&&X(_),e=!0):J===r?(d&&h!==d?X(d):a.focus(),e=!0):Q!==r&&" "!==r||(K(n,m),E(n,m)?(X(n),ot(g(n))):ot(g(vt(s))),e=!0);else{var k=[];if(Z(s,(function(t,e){E(t,m)&&k.push(e),n!==t&&D(t,m)})),W===r)(c=lt(s))&&X(c),e=!0;else if(G===r)(l=vt(s))&&X(l),e=!0;else if(Q===r||" "===r)K(n,m),E(n,m)?(X(n),ot(g(n))):ot(g(vt(s))),e=!0;else if(F===r)_&&X(_),e=!0;else if(J===r)d&&h!==d?X(d):a.focus(),e=!0;else if($===r){if(a.let(v=et(n),1),f(k)>1)for(var y,w;w=k.pop();)_=(y=rt(w,s))&&x(y),a.let(w,1);a.fire("change",[t,v]),_?(X(_),ot(g(_))):a.focus(),e=!0}else if("Delete"===r){if(a.let(v=et(n),1),f(k)>1)for(var j;j=k.shift();)d=rt(j,s)&&b(j),a.let(j,1);a.fire("change",[t,v]),d&&h!==d?(X(d),ot(g(d))):a.focus(),e=!0}else"Escape"===r||"Tab"===r?(a.focus(),e=!0):(a.focus(),e=!1)}e&&B(t)}function Tt(t){var e=t.key,n=tt(this),r=n._tags,i=n.state.n+"__tag--selected";if(n._event=t,dt)if(F===e||J===e);else{var u=0;Z(r,(function(t){E(t,i)&&++u})),u<2&&D(this,i)}gt=dt=!1}function Ct(e){var n=e.data,r=tt(this),i=r.state.escape,u=s(n)&&1===f(n)?n:0;if(r._event=e,"\n"===u&&(t("\n",i)||t(13,i))||"\t"===u&&(t("\t",i)||t(9,i))||t(u,i))return r.set(w(this)).focus().text="",B(e)}function Rt(e){var n,i=this,u=e.key,a=e.keyCode,o=gt=e.ctrlKey,s=dt=e.shiftKey,f=tt(i),c=f._active,l=f._mask,v=f._tags;f.mask;var _,d,m=f.self,b=f.state,k=l.hint,x=b.n+"__tag--selected";if(escape=b.escape,!c)return B(e);if(f._event=e,Q===u&&(t("\n",escape)||t(13,escape))||"Tab"===u&&(t("\t",escape)||t(9,escape))||t(u,escape)||t(a,escape))return f.set(w(i)).focus().text="",B(e);M((function(){return z(k,w(i,!1)?"":m.placeholder)}),1)();var j,E=""===function(t){var e,n=h.getSelection();if(n.rangeCount)return(e=n.getRangeAt(0).cloneRange()).collapse(!0),e.setStart(t,0),(e+"").slice(-1)}(i),S=null===w(i,!1);if(s)(S||E)&&F===u&&(d=vt(v))&&(d&&(X(d),ot(g(d))),L(d,x),n=!0);else if(o)"a"===u&&null===w(i,!1)&&null!==f.value?(Z(v,(function(t){X(t),ot(g(t)),L(t,x)})),n=!0):W===u?((_=lt(v))&&X(_),n=!0):G===u||F===u?((d=vt(v))&&X(d),n=!0):$===u&&((d=vt(v))&&f.let(et(d)),f.focus(),n=!0);else if(Q===u){var A=y(m);if(A&&r(A.requestSubmit)){var D=(j="button:not([type]),button[type=submit],input[type=image],input[type=submit]",(A||p).querySelector(j));D?A.requestSubmit(D):A.requestSubmit()}n=!0}else S?W===u?((_=lt(v))&&X(_),n=!0):G===u||F===u?((d=vt(v))&&X(d),n=!0):$===u&&((d=vt(v))&&f.let(et(d)),f.focus(),n=!0):E&&F===u&&((d=vt(v))&&X(d),n=!0);n&&B(e)}function Lt(t){tt(this)._event=t,gt=dt=!1}function qt(t){var e=tt(this),n=e._tags,r=e.state,i=r.n+"__tag--selected",u=!0,a=(t.clipboardData||h.clipboardData).getData("text")+"";e._event=t;try{Z(n,(function(t){if(!E(t,i))throw u=!1,""}))}catch(t){}u&&e.value&&Y(e.value.split(r.join),(function(t){return e.let(t,1)}));var o=a.split(r.join);Y(o,(function(t){return e.set(t,-1,1)})),e.fire("paste",[t,o]).focus().fire("change",[t]),B(t)}function Nt(t){var e=this,n=tt(e),r=n._mask,i=n.self,u=n.state,a=r.hint,o=(t.clipboardData||h.clipboardData).getData("text")+"";n._event=t,function(t,e){var n,r=h.getSelection();r.rangeCount&&((n=r.getRangeAt(0)).deleteContents(),n.insertNode(p.createTextNode(e)))}(0,o),z(a,w(e)?"":i.placeholder),M((function(){if(o=w(e),n.text="",o){var r=o.split(u.join);Y(r,(function(t){return n.set(t,-1,1)})),n.fire("paste",[t,r]).fire("change",[t])}}),1)(),B(t)}function Ot(t){var e=this,n=tt(e),r=n._active,i=n._mask,u=n._tags,a=n.state,o=i.text,s=a.n+"__tag--selected";if(r){if(n._event=t,X(e),K(e,s),gt);else if(dt){at();var c,l=k(e),v=(y="."+s,(l||p).querySelectorAll(y)),h=v[0],_=v[f(v)-1];if(h!==_)for(;(c=b(h))&&o!==c&&h!==_;)L(h=c,s)}else{at();var d=2===t.button,m=0;Z(u,(function(t){E(t,s)&&++m,e===t||d||D(t,s)})),m>0&&L(e,s)}var y;E(e,s)?(X(e),ot(g(e))):ot(vt(u)),n.fire("touch.tag",[t]),B(t),function(t){t&&t.stopPropagation()}(t)}}function zt(t){var e=this,n=k(e),r=tt(n);r._event=t,P("mousedown",e,zt),P("touchstart",e,zt),r.let(et(n)).focus(),B(t)}function Kt(t){var e=tt(this);e._event=t,e.let().fire("reset",[t])}function Mt(t){var e=tt(this),n=e._tags,r=e.state;return e._event=t,n.size<r.min?(e.fire("min.tags",[t]).focus(),B(t)):e.fire("submit",[t])}return _t.attach=function(t,n){var i=this;if(t=t||i.self,n&&s(n)&&(n={join:n}),n=l({},i.state,n||{}),E(t,n.n+"__self"))return i;(function(t){return t.required})(t)&&!n.min&&(n.min=1),i._active=!ut(t)&&!function(t){return t.readOnly}(t),i._event=null,i._tags=new Map,i._value=nt(t)||null,i.self=t,i.state=n;var u=n.n,c=y(t),v=q("div",{class:u,tabindex:!ut(t)&&-1});i.mask=v;var p,h,_=q("span",{class:u+"__tags"}),g=q("span",{class:u+"__text"}),d=q("span",{autocapitalize:"off",contenteditable:!ut(t)&&"",spellcheck:"false"}),m=q("span",t.placeholder+"");R(v,_),R(_,g),R(g,d),R(g,m),L(t,u+"__self"),h=v,k(p=t).insertBefore(h,b(p,!0)),c&&(st(c,i),I("reset",c,Kt),I("submit",c,Mt)),I("beforeinput",d,Ct),I("blur",d,bt),I("click",v,kt),I("focus",t,Et),I("focus",d,jt),I("invalid",t,St),I("keydown",d,Rt),I("keyup",d,Lt),I("paste",d,Nt),t.tabIndex=-1,st(v,i),st(d,i);var x={};if(x.hint=m,x.input=d,x.of=t,x.self=v,x.tags=_,x.text=g,i._mask=x,i._value&&Y(i._value.split(n.join),(function(t){return i.set(t,-1,1,1)})),o(n)&&e(n.with))for(var w=0,j=f(n.with);w<j;++w){var S=n.with[w];s(S)&&(S=ht[S]),r(S)?S.call(i,t,n):a(S)&&r(S.attach)&&S.attach.call(i,t,n)}return i},_t.blur=function(){at();var t=this._mask,e=this._tags,n=t.input;return Z(e,(function(t){return t.blur()})),n.blur()},_t.detach=function(){var t=this,n=t._mask,i=t.mask,u=t.self,o=t.state,c=n.input;if(!E(u,o.n+"__self"))return t;var l=y(u);if(t._active=!1,t._value=nt(u)||null,l&&(P("reset",l,Kt),P("submit",l,Mt)),P("beforeinput",c,Ct),P("blur",c,bt),P("click",i,kt),P("focus",c,jt),P("focus",u,Et),P("invalid",u,St),P("keydown",c,Rt),P("keyup",c,Lt),P("paste",c,Nt),e(o.with))for(var v=0,p=f(o.with);v<p;++v){var h=o.with[v];s(h)&&(h=ht[h]),a(h)&&r(h.detach)&&h.detach.call(t,u,o)}return u.tabIndex=null,D(u,o.n+"__self"),T(i),t._mask={of:u},t.mask=null,t},_t.focus=function(t){var e=this._mask.input;return e&&(X(e),ot(e,t)),this},_t.get=function(t){var e=this,n=e._active,r=e._event,i=e._tags;if(!n)return!1;if(e.fire("get.tag",[r,t]),!it(t,i))return null;var u=-1;try{Z(i,(function(e,n){if(++u,t===n)throw""}))}catch(t){}return u},_t.let=function(t,e){var r=this,i=r._active,u=r._event,a=r._tags,o=r._value,s=r.self,f=r.state;if(!i)return r;if(!n(t))return r.value&&Y(r.value.split(f.join),(function(t){return r.let(t,1)})),Y(o.split(f.join),(function(t){return r.set(t,-1,1)})),r.fire("change",[u]);if(a.size<f.min+1)return r.fire("min.tags",[u,t]);if(!it(t,a))return r.fire("not.tag",[u,t]);r.fire("is.tag",[u,t]);var c=rt(t,a);_(c,0);var l,v=_(c,1);return P("blur",c,mt),P("contextmenu",c,yt),P("copy",c,xt),P("cut",c,wt),P("focus",c,At),P("keydown",c,Dt),P("keyup",c,Tt),P("mousedown",c,Ot),P("mousedown",v,zt),P("paste",c,qt),P("touchstart",c,Ot),P("touchstart",v,zt),T(c),l=t,r._tags.delete(l),s.value=ct(r._tags).join(f.join),r.fire("let.tag",[u,t]),e||r.fire("change",[u,t]),r},_t.set=function(t,e,n,i){var a=this,o=a._active,f=a._event,c=a._convert,l=a._mask,v=a._tags,p=a.self,h=a.state,_=l.text,g=h.pattern,d=h.n;if(!o&&!i)return a;if(v.size>=h.max)return a.fire("max.tags",[f,t]);if(r(c)&&(t=c.call(a,t)),""===t||s(g)&&!H(g).test(t))return a.fire("not.tag",[f,t]);if(it(t,v))return a.fire("has.tag",[f,t]);a.fire("is.tag",[f,t]);var m=q("span",{class:d+"__tag","data-name":t,tabindex:!!o&&-1}),b=q("span",t.replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;")),k=q("span",{class:d+"__x",tabindex:-1});if(o&&(I("blur",m,mt),I("contextmenu",m,yt),I("copy",m,xt),I("cut",m,wt),I("focus",m,At),I("keydown",m,Dt),I("keyup",m,Tt),I("mousedown",m,Ot),I("mousedown",k,zt),I("paste",m,qt),I("touchstart",m,Ot),I("touchstart",k,zt),st(m,a)),R(m,b),R(m,k),function(t){return u(t)&&0==t%1}(e)&&e>=0){var y=ct(v);y.splice(e,0,t),a._tags=new Map,ft(t,m,v),Y(y,(function(t){var e;ft(t,e=rt(t,v),a._tags),O(_,e)}))}else O(_,m),ft(t,m,a._tags);return p.value=ct(a._tags).join(h.join),a.fire("set.tag",[f,t]),n||a.fire("change",[f,t]),a},ht}));