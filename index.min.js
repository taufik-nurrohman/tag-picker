/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).TagPicker=e()}(this,(function(){"use strict";var t=function(t){return Array.isArray(t)},e=function(t){return"function"==typeof t},n=function(t,e){return t&&u(e)&&t instanceof e},s=function(t,e){return void 0===e&&(e=!0),"object"==typeof t&&(!e||n(t,Object))},u=function(t){return function(t){return void 0!==t}(t)&&!function(t){return null===t}(t)},o=function(t){return"string"==typeof t},r=function(t){return t.toLowerCase()},i=function(t){return t.length},a=function(t){return Object.keys(t)},c=function(t){return Object.values(t)},f=function e(){for(var n=arguments.length,o=Array(n),r=0;r<n;r++)o[r]=arguments[r];for(var a,c=o.shift(),f=0,l=i(o);f<l;++f)for(var v in o[f])if(u(c[v]))if(t(c[v])&&t(o[f][v])){c[v]=[].concat(c[v]);for(var p=0,h=i(o[f][v]);p<h;++p)a=o[f][v][p],-1===c[v].indexOf(a)&&c[v].push(o[f][v][p])}else s(c[v])&&s(o[f][v])?c[v]=e({},c[v],o[f][v]):c[v]=o[f][v];else c[v]=o[f][v];return c},l=function e(n){if(t(n))return n.map((function(t){return e(n)}));if(s(n)){for(var u in n)n[u]=e(n[u]);return n}return!1===n?"false":null===n?"null":!0===n?"true":""+n},v=document,p=window,h=function(t,e){return t["next"+(e?"":"Element")+"Sibling"]||null},_=function(t,e){return e?t.closest(e)||null:t.parentNode||null},m=function(t){var e="form";return y(t,e)&&e===function(t){return r(t&&t.nodeName||"")||null}(t[e])?t[e]:_(t,e)},d=function(t,e){return t.previousElementSibling||null},g=function(t,e){void 0===e&&(e=!0);var n="textContent";if(!y(t,n))return!1;var s=t[n];return""!==(s=e?s.trim():s)?s:null},k=function(t,e){return t.classList.contains(e)},y=function(t,e){return e in t},b=function(t,e){return t.removeAttribute(e),t},x=function(t,e){return t.classList.remove(e),t},j=function(t){var e=_(t);return t.remove(),e},w=function(t,e,n){return!0===n&&(n=e),t.setAttribute(e,l(n)),t},E=function(t,e){return t.append(e),e},A=function(t,e){return t.classList.add(e),t},K=function(t,e,n){return t=o(t)?v.createElement(t):t,s(e)&&(n=e,e=!1),o(e)&&L(t,e),s(n)&&function(t,e){var n;for(var s in e)(n=e[s])||""===n||0===n?w(t,s,n):b(t,s)}(t,n),t},L=function(t,e,n){if(void 0===n&&(n=!0),null===e)return t;var s="innerHTML";return y(t,s)&&(t[s]=n?e.trim():e),t},S=function(t,e,n){if(void 0===n&&(n=!0),null===e)return t;var s="textContent";return y(t,s)&&(t[s]=n?e.trim():e),t},R=function(t,e,n){return t.classList.toggle(e,n),t},C=function(t,e){return function(){var n=arguments,s=this;setTimeout((function(){return t.apply(s,n)}),e)}};var T=function(t,e,n){e.removeEventListener(t,n)},O=function(t){return t&&t.preventDefault()},q=function(t,e,n,s){void 0===s&&(s=!1),e.addEventListener(t,n,s)},P=function(t,e){return function(t){return n(t,RegExp)}(t)?t:RegExp(t,u(e)?e:"g")},B="ArrowLeft",N="ArrowRight",D="Home",H="Backspace",I="End",M="Enter",V={focusVisible:!0},W="TagPicker";function Z(t,e,n){Object.defineProperty(t,e,n)}function $(t){return t.disabled}function z(t){var e,n=v.createRange();n.selectNodeContents(t),n.collapse(!1),(e=p.getSelection()).removeAllRanges(),e.addRange(n)}function F(t,e){var s=this;return t?n(s,F)?(t["_"+W]=function(t,e){return(e=e||t).fire=function(t,e){var n=this,s=n.hooks;return u(s[t])?(s[t].forEach((function(t){return t.apply(n,e)})),n):n},e.off=function(t,e){var n=this,s=n.hooks;if(!u(t))return s={},n;if(u(s[t]))if(u(e)){var o=s[t].length;if(0===o)delete s[t];else for(var r=0;r<o;++r)if(e===s[t][r]){s[t].splice(r,1);break}}else delete s[t];return n},e.on=function(t,e){var n=this.hooks;return u(n[t])||(n[t]=[]),u(e)&&n[t].push(e),this},t.hooks={},t}(s,F.prototype),s.attach(t,f({},F.state,o(e)?{join:e}:e||{}))):new F(t,e):s}F.state={class:"tag-picker",escape:[","],join:", ",max:9999,min:0,pattern:null,with:[]},F.version="4.0.0",Z(F,"name",{value:W});var G=F.prototype;function J(){var t=this["_"+W].state;x(this,t.class+"--focus")}function Q(){var t=this["_"+W];t._mask;var e=t.mask,n=t.state.class;x(e,n+="--focus"),x(e,n+="-tag")}function U(){var t=this["_"+W],e=t._mask,n=t.mask,s=t.state,u=e.text,o=s.class;x(u,o+"__text--focus"),x(n,o+="--focus"),x(n,o+="-text")}function X(t){var e=this["_"+W],n=e._mask,s=e._tags,u=e.mask,o=e.state,r=n.copy,a=o.class+"__tag--focus",c=[];for(var f in s)k(s[f],a)&&c.push(f);i(c)&&(u!==_(r)&&(r.value=c.join(o.join),E(u,r)),r.focus(),r.select())}function Y(){var t=this,e=t["_"+W];e._mask.input,C((function(){return j(t),e.focus()}),1)()}function tt(){var t=this,e=t["_"+W],n=e._mask,s=e.state;n.input,t.value.split(s.join).forEach((function(t){return e.let(t)})),C((function(){return j(t),e.focus()}),1)()}function et(){var t=this["_"+W];t._tags;var e=t.mask,n=t.state.class;A(e,n+"--focus"),rt||A(e,n+"--select")}function nt(){it=!1;var t=this["_"+W],e=t._mask,n=t._tags,s=t.mask,u=t.self,o=t.state,r=e.copy,i=e.hint,a=e.input,c=e.text,f=o.class;for(var l in n)x(n[l],f+"__tag--focus");j(r),x(s,f+"--select"),A(c,f+"__text--focus"),A(s,f+="--focus"),A(s,f+="-text"),z(a),C((function(){return S(i,g(a,!1)?"":u.placeholder)}),1)()}function st(){this["_"+W].focus()}function ut(){var t=this["_"+W].state.class;A(this,t+"--focus")}function ot(){var t=this["_"+W];t._mask;var e=t.mask,n=t.state.class;A(e,n+="--focus"),A(e,n+="-tag")}Z(G,"text",{get:function(){return g(this._mask.input)},set:function(t){S(this._mask.input,t)}}),Z(G,"value",{get:function(){var t=this.self.value;return""===t?null:t},set:function(t){var e=this,n=e.state;t.split(n.join).forEach((function(t){return e.set(t)}))}}),G._filter=function(t){var e,n,s=this.state;return t=(t||"").split(s.join).join("").trim(),(e=t,void 0===n&&(n="-"),e.replace(/[A-Z]/g,(function(t){return n+r(t)})).replace(/\W+/g,n)).replace(/^-+|-+$/g,"")};var rt=!1,it=!1;function at(t){rt=t.ctrlKey,t.shiftKey}function ct(t){var e,n,s,u=this,o=t.key,r=rt=t.ctrlKey,i=t.shiftKey,a=u["_"+W],f=a._mask,l=a._tags,v=a.mask,p=a.state,_=f.copy,m=f.text,g=d(u),k=h(u),y=p.class+"__tag--focus";if(i)A(it=u,y),_.value=a.value,E(v,_),_.focus(),_.select();else if(r){if(x(v,p.class+"--select"),!i&&"a"===o){for(var b in l)A(l[b],y);_.value=a.value,E(v,_),_.focus(),_.select(),e=!0}}else i||x(u,y),D===o?((n=c(l).shift())&&n.focus(V),e=!0):I===o?((s=c(l).pop())&&s.focus(V),e=!0):M===o||" "===o?(R(u,y),e=!0):B===o?(g&&g.focus(V),e=!0):N===o?(k&&m!==k?k.focus(V):a.focus(),e=!0):H===o?(a.let(u.title),g?g.focus(V):a.focus(),e=!0):"Delete"===o&&(a.let(u.title),k&&m!==k?k.focus(V):a.focus(),e=!0);e&&O(t)}function ft(t){var e=this,n=t.key,s=t.altKey,u=rt=t.ctrlKey,o=t.shiftKey,r=e["_"+W],i=r._mask,a=r._tags,f=r.mask,l=r.state,v=i.copy;i.input;var p,_,m,g,k=i.text,y=l.class+"__tag--focus";if(!s)if(o)it=it||a[e.value.split(l.join).shift()],console.log(it),B===n?(g=d(it))&&(console.log(g),A(g,y),it=g):N===n&&(m=h(it))&&(console.log(m),k!==m&&(A(m,y),it=m));else if(u){if(x(f,l.class+"--select"),"a"===n){for(var b in a)A(a[b],y);v.value=r.value,v.focus(),v.select()}}else B===n?(p=a[e.value.split(l.join).shift()],w(),(g=d(p))?g.focus(V):p.focus(V)):N===n?(_=a[e.value.split(l.join).pop()],w(),(m=h(_))&&k!==m?m.focus(V):_.focus(V)):D===n?(w(),c(a).shift().focus(V)):I===n?(w(),c(a).pop().focus(V)):M===n||" "===n?(_=e.value.split(l.join).pop(),w(),a[_].focus(V),O(t)):"Escape"===n?(w(),r.focus()):(e.value.split(l.join).forEach((function(t){return r.let(t)})),r.focus());function w(){for(var t in j(v),a)x(a[t],y)}}function lt(t){var n,s,u,o,r=this,i=t.key,a=t.keyCode,f=rt=t.ctrlKey,l=t.shiftKey,h=r["_"+W],_=h._mask,d=h._tags,k=h.mask,y=h.self,b=h.state,x=_.copy,j=_.hint,w=b.class+"__tag--focus";if((escape=b.escape).includes(i)||escape.includes(a))return h.set(g(r)),S(r,""),S(j,y.placeholder),h.focus(),O(t);C((function(){return S(j,g(r,!1)?"":y.placeholder)}),1)();var K,L=""===function(t){var e,n=p.getSelection();if(n.rangeCount>0)return(e=n.getRangeAt(0).cloneRange()).collapse(!0),e.setStart(t,0),(e+"").slice(-1)}(r),R=null===g(r,!1);if(D===i&&(f||R))(u=c(d).shift())&&u.focus(V),n=!0;else if(I===i&&(f||R))(o=c(d).pop())&&o.focus(V),n=!0;else if(B===i&&(f||L))(o=c(d).pop())&&o.focus(V),n=!0;else if(H===i&&R)(o=c(d).pop())&&h.let(o.title),h.focus(),n=!0;else if(M===i){var T=m(y);if(T&&e(T.requestSubmit)){var q=(K="button:not([type]),button[type=submit],input[type=image],input[type=submit]",(T||v).querySelector(K));q?T.requestSubmit(q):T.requestSubmit()}n=!0}else if(f&&!l&&"a"===i&&null===g(r,!1)&&null!==(s=h.value)){for(var P in d)A(d[P],w);x.value=s,E(k,x),x.focus(),x.select(),n=!0}n&&O(t)}function vt(){var t=this["_"+W],e=t._mask,n=t._tags,s=t.mask,u=t.state,o=e.copy,r=u.class+"__tag--focus";rt=!1;var a=[];for(var c in n)k(n[c],r)&&a.push(c);i(a)&&(o.value=a.join(u.join),E(s,o),o.focus(),o.select())}function pt(){var t=this,e=t.value,n=t["_"+W],s=n._mask,u=n.state,o=s.copy;s.input,C((function(){""!==e&&e.split(u.join).forEach((function(t){return n.let(t)})),""!==(e=t.value)&&e.split(u.join).forEach((function(t){return n.set(t)})),j(o),n.focus()}),1)()}function ht(){var t=this,e=t["_"+W],n=e._mask,s=e.state,u=n.hint;C((function(){var n=g(t);null!==n&&n.split(s.join).forEach((function(t){return e.set(t)})),S(t,""),S(u,e.self.placeholder)}),1)()}function _t(t){var e=this["_"+W],n=e._mask,s=e._tags,u=e.mask,o=e.state,r=n.copy,i=n.input,a=o.class+"__tag--focus";if(u===_(r))if(i===t.target){for(var c in s)k(s[c],a);e.focus()}else r.focus(),r.select();else e.focus();O(t)}function mt(t){var e=this,n=e["_"+W],s=n._mask,u=n._tags,o=n.mask,r=n.state,i=s.copy,a=r.class+"__tag--focus";if(rt){R(e,a);var c=[];for(var f in u)k(u[f],a)&&c.push(f);i.value=c.join(r.join),i.focus(),i.select()}else{var l=0;for(var v in u)e!==u[v]&&(k(u[v],a)&&++l,x(u[v],a));l>1?A(e,a):R(e,a),k(e,a)?(i.value=e.title,E(o,i),C((function(){return i.focus(),i.select()}),1)()):j(i)}!function(t){t&&t.stopPropagation()}(t)}function dt(t){var e=_(this),n=e["_"+W];n._mask.input,T("click",this,dt),n.let(e.title),n.focus(),O(t)}return G.attach=function(n,r){var a=this;n=n||a.self,r=r||a.state,a._active=!0,a._tags={},a._value=function(t){return t.value.replace(/\r/g,"")}(n),a.self=n,a.state=r;var c=r.class,f="_"+W;m(n);var l=K("div",{class:c,tabindex:!$(n)&&-1});a.mask=l;var v,p,d=K("span",{class:c+"__tags"}),g=K("span",{class:c+"__text"}),k=K("input",{class:c+"__copy",tabindex:-1,type:"text"}),y=K("span",{contenteditable:!$(n)&&"true",spellcheck:"false",style:"white-space:pre;"}),b=K("span",n.placeholder+"");E(l,d),E(d,g),E(g,y),E(g,b),A(n,c+"__self"),p=l,_(v=n).insertBefore(p,h(v,!0)),q("blur",l,J),q("blur",y,U),q("contextmenu",l,X),q("copy",k,Y),q("cut",k,tt),q("focus",l,ut),q("focus",n,st),q("focus",k,et),q("focus",y,nt),q("keydown",l,at),q("keydown",k,ft),q("keydown",y,lt),q("keyup",l,vt),q("mousedown",l,_t),q("paste",k,pt),q("paste",y,ht),q("touchstart",l,_t),n.tabIndex=-1,l[f]=a,k[f]=a,y[f]=a;var x={};if(x.copy=k,x.hint=b,x.input=y,x.of=n,x.self=l,x.tags=d,x.text=g,a._mask=x,u(r)&&t(r.with))for(var j=0,w=i(r.with);j<w;++j){var L=r.with[j];o(L)&&(L=F[L]),e(L)?L.call(a,n,r):s(L)&&e(L.attach)&&L.attach.call(a,n,r)}return a},G.blur=function(){},G.click=function(){},G.detach=function(){var n=this,u=n._mask,r=n.mask,a=n.self,c=n.state,f=u.copy,l=u.input;if(n._active=!1,T("blur",l,U),T("blur",r,J),T("contextmenu",r,X),T("copy",f,Y),T("cut",f,tt),T("focus",f,et),T("focus",l,nt),T("focus",r,ut),T("focus",a,st),T("keydown",f,ft),T("keydown",l,lt),T("keydown",r,at),T("keydown",r,vt),T("mousedown",r,_t),T("paste",f,pt),T("paste",l,ht),T("touchstart",r,_t),t(c.with))for(var v=0,p=i(c.with);v<p;++v){var h=c.with[v];o(h)&&(h=F[h]),s(h)&&e(h.detach)&&h.detach.call(n,a,c)}return a.tabIndex=null,x(a,c.class+"__self"),j(r),n._mask={of:a},n.mask=null,n},G.focus=function(){var t=this._mask.input;return t&&t.focus(),z(t),this},G.get=function(t){var e=this._active,n=this._tags;return!!e&&(n[t]?t:null)},G.let=function(t){var e=this,n=e._active,s=e._tags,u=e.self,o=e.state;if(!n)return e;if(!s[t])return!1;var r=s[t],i=r.firstElementChild||null;return T("blur",r,Q),T("focus",r,ot),T("keydown",r,ct),T("mousedown",r,mt),T("mousedown",i,dt),T("touchstart",r,mt),T("touchstart",i,dt),j(r),delete e._tags[t],u.value=a(e._tags).join(o.join),e},G.set=function(t){var n=this,s=n._active,u=n._filter,r=n._mask,i=n._tags,c=n.self,f=n.state,l=r.text,v=f.pattern,p=f.class;if(!s)return n;if(e(u)&&(t=u.call(n,t)),o(v)&&P(v)&&!P(v).test(t))return!1;if(""===t||i[t])return!1;var h,m,d=K("span",{class:p+="__tag",tabindex:-1,title:t}),g=K("span",{class:p+="-x",tabindex:-1});return q("blur",d,Q),q("focus",d,ot),q("keydown",d,ct),q("mousedown",d,mt),q("mousedown",g,dt),q("touchstart",d,mt),q("touchstart",g,dt),d["_"+W]=n,E(d,g),m=d,_(h=l).insertBefore(m,h),n._tags[t]=d,c.value=a(n._tags).join(f.join),n},F}));