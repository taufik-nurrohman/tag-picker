/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).TagPicker=e()}(this,(function(){"use strict";var t=function(t){return Array.isArray(t)},e=function(t){return"function"==typeof t},n=function(t,e){return t&&s(e)&&t instanceof e},r=function(t,e){return void 0===e&&(e=!0),"object"==typeof t&&(!e||n(t,Object))},s=function(t){return function(t){return void 0!==t}(t)&&!function(t){return null===t}(t)},i=function(t){return"string"==typeof t},u=function(t){return t.toLowerCase()},a=function(t){return t.length},o=function(t){return Object.keys(t)},c=function(t){return Object.values(t)},f=function e(){for(var n=arguments.length,i=Array(n),u=0;u<n;u++)i[u]=arguments[u];for(var o,c=i.shift(),f=0,l=a(i);f<l;++f)for(var v in i[f])if(s(c[v]))if(t(c[v])&&t(i[f][v])){c[v]=[].concat(c[v]);for(var p=0,h=a(i[f][v]);p<h;++p)o=i[f][v][p],-1===c[v].indexOf(o)&&c[v].push(i[f][v][p])}else r(c[v])&&r(i[f][v])?c[v]=e({},c[v],i[f][v]):c[v]=i[f][v];else c[v]=i[f][v];return c},l=function e(n){if(t(n))return n.map((function(t){return e(n)}));if(r(n)){for(var s in n)n[s]=e(n[s]);return n}return!1===n?"false":null===n?"null":!0===n?"true":""+n},v=document,p=window,h=function(t){return t.firstElementChild||null},_=function(t,e){return t["next"+(e?"":"Element")+"Sibling"]||null},d=function(t,e){return e?t.closest(e)||null:t.parentNode||null},g=function(t){var e="form";return y(t,e)&&e===function(t){return u(t&&t.nodeName||"")||null}(t[e])?t[e]:d(t,e)},m=function(t,e){void 0===e&&(e=!0);var n="textContent";if(!y(t,n))return!1;var r=t[n];return""!==(r=e?r.trim():r)?r:null},k=function(t,e){return t.classList.contains(e)},y=function(t,e){return e in t},b=function(t,e){return t.removeAttribute(e),t},x=function(t,e){return t.classList.remove(e),t},w=function(t){var e=d(t);return t.remove(),e},j=function(t,e,n){return!0===n&&(n=e),t.setAttribute(e,l(n)),t},E=function(t,e){return t.append(e),e},A=function(t,e){return t.classList.add(e),t},S=function(t,e,n){return t=i(t)?v.createElement(t):t,r(e)&&(n=e,e=!1),i(e)&&L(t,e),r(n)&&function(t,e){var n;for(var r in e)(n=e[r])||""===n||0===n?j(t,r,n):b(t,r)}(t,n),t},L=function(t,e,n){if(void 0===n&&(n=!0),null===e)return t;var r="innerHTML";return y(t,r)&&(t[r]=n?e.trim():e),t},R=function(t,e,n){if(void 0===n&&(n=!0),null===e)return t;var r="textContent";return y(t,r)&&(t[r]=n?e.trim():e),t},C=function(t,e,n){return t.classList.toggle(e,n),t},D=function(t,e){return function(){var n=arguments,r=this;setTimeout((function(){return t.apply(r,n)}),e)}};var T=function(t,e,n){e.removeEventListener(t,n)},O=function(t){return t&&t.preventDefault()},q=function(t,e,n,r){void 0===r&&(r=!1),e.addEventListener(t,n,r)},K=function(t,e){return function(t){return n(t,RegExp)}(t)?t:RegExp(t,s(e)?e:"g")},P="ArrowLeft",B="Home",N="Backspace",H="End",I="Enter",M={focusVisible:!0},V="TagPicker";function W(t,e,n){Object.defineProperty(t,e,n)}function Z(t){v.getSelection().removeAllRanges()}function $(t){t.focus()}function z(t){return t.disabled}function F(t){var e=v.getSelection();Z();var n=v.createRange();n.selectNodeContents(t),e.addRange(n)}function G(t,e){var r=this;return t?n(r,G)?(t["_"+V]=function(t,e){return(e=e||t).fire=function(t,e){var n=this,r=n.hooks;return s(r[t])?(r[t].forEach((function(t){return t.apply(n,e)})),n):n},e.off=function(t,e){var n=this,r=n.hooks;if(!s(t))return r={},n;if(s(r[t]))if(s(e)){var i=r[t].length;if(0===i)delete r[t];else for(var u=0;u<i;++u)if(e===r[t][u]){r[t].splice(u,1);break}}else delete r[t];return n},e.on=function(t,e){var n=this.hooks;return s(n[t])||(n[t]=[]),s(e)&&n[t].push(e),this},t.hooks={},t}(r,G.prototype),r.attach(t,f({},G.state,i(e)?{join:e}:e||{}))):new G(t,e):r}G.state={class:"tag-picker",escape:[","],join:", ",max:9999,min:0,pattern:null,with:[]},G.version="4.0.0",W(G,"name",{value:V});var J=G.prototype;W(J,"text",{get:function(){return m(this._mask.input)},set:function(t){R(this._mask.input,t)}}),W(J,"value",{get:function(){var t=this.self.value;return""===t?null:t},set:function(t){var e=this,n=e.state;t.split(n.join).forEach((function(t){return e.set(t)}))}}),J._filter=function(t){var e,n,r=this.state;return t=(t||"").split(r.join).join("").trim(),(e=t,void 0===n&&(n="-"),e.replace(/[A-Z]/g,(function(t){return n+u(t)})).replace(/\W+/g,n)).replace(/^-+|-+$/g,"")};var Q=!1;function U(){var t=this["_"+V];t._mask;var e=t.mask,n=t.state.class;x(e,n+="--focus"),x(e,n+="-tag"),Z()}function X(){var t=this["_"+V],e=t._mask,n=t.mask,r=t.state,s=e.text,i=r.class;x(s,i+"__text--focus"),x(n,i+="--focus"),x(n,i+="-text"),Z()}function Y(t){var e=this,n=e["_"+V];n._tags;var r=n.state.class+"__tag--focus";A(e,r),$(e),F(h(e))}function tt(t){var e=this["_"+V],n=e._tags,r=e.state,s=r.class+"__tag--focus",i=[];for(var u in n)k(n[u],s)&&i.push(u);t.clipboardData.setData("text/plain",i.join(r.join)),O(t),console.log(i)}function et(t){var e=this["_"+V],n=e._mask,r=e._tags,s=e.state,i=n.input,u=s.class+"__tag--focus",a=[];for(var o in r)k(r[o],u)&&(a.push(o),w(r[o]),delete r[o]);t.clipboardData.setData("text/plain",a.join(s.join)),$(i),F(i),O(t),console.log(a)}function nt(){var t=this["_"+V],e=t._mask,n=t._tags,r=t.mask,s=t.self,i=t.state,u=e.hint,a=e.input,o=e.text,c=i.class;for(var f in n)x(n[f],c+"__tag--focus");A(o,c+"__text--focus"),A(r,c+="--focus"),A(r,c+="-text"),$(a),F(a),D((function(){return R(u,m(a,!1)?"":s.placeholder)}),1)()}function rt(){this["_"+V].focus()}function st(){var t=this["_"+V];t._mask;var e=t.mask,n=t.state.class;A(e,n+="--focus"),A(e,n+="-tag")}function it(t){var e,n=this,r=t.key,s=Q=t.ctrlKey,i=t.shiftKey,u=n["_"+V],a=u._mask,o=u._tags;u.mask;var f,l,v=u.state,p=a.text,d=n.previousElementSibling||null,g=_(n),m=v.class+"__tag--focus";if(i)A(n,m);else if(s){if("a"===r){for(var y in o)$(o[y]),F(h(o[y])),A(o[y],m);e=!0}}else x(n,m),B===r?((f=c(o).shift())&&f.focus(M),e=!0):H===r?((l=c(o).pop())&&l.focus(M),e=!0):I===r||" "===r?(C(n,m),k(n,m),e=!0):P===r?(d&&d.focus(M),e=!0):"ArrowRight"===r?(g&&p!==g?g.focus(M):u.focus(),e=!0):N===r?(u.let(n.title),d?d.focus(M):u.focus(),e=!0):"Delete"===r&&(u.let(n.title),g&&p!==g?g.focus(M):u.focus(),e=!0);e&&O(t)}function ut(){Q=!1}function at(t){var n,r,s,i=this,u=t.key,a=t.keyCode,o=Q=t.ctrlKey,f=t.shiftKey,l=i["_"+V],_=l._mask,d=l._tags,k=l.mask,y=l.self,b=l.state,x=_.hint,w=b.class+"__tag--focus";if((escape=b.escape).includes(u)||escape.includes(a))return l.set(m(i)),R(i,""),R(x,y.placeholder),l.focus(),O(t);D((function(){return R(x,m(i,!1)?"":y.placeholder)}),1)();var j,E=""===function(t){var e,n=p.getSelection();if(n.rangeCount>0)return(e=n.getRangeAt(0).cloneRange()).collapse(!0),e.setStart(t,0),(e+"").slice(-1)}(i),S=null===m(i,!1);if(f)(S||E)&&P===u&&(s=c(d).pop())&&(s&&s.focus(M),A(s,w),A(k,b.class+"--select"),n=!0);else if(o)if("a"===u&&null===m(i,!1)&&null!==l.value){for(var L in d)$(d[L]),F(h(d[L])),A(d[L],w);n=!0}else B===u?((r=c(d).shift())&&r.focus(M),n=!0):H===u||P===u?((s=c(d).pop())&&s.focus(M),n=!0):N===u&&((s=c(d).pop())&&l.let(s.title),l.focus(),n=!0);else if(I===u){var C=g(y);if(C&&e(C.requestSubmit)){var T=(j="button:not([type]),button[type=submit],input[type=image],input[type=submit]",(C||v).querySelector(j));T?C.requestSubmit(T):C.requestSubmit()}n=!0}else S?B===u?((r=c(d).shift())&&r.focus(M),n=!0):H===u||P===u?((s=c(d).pop())&&s.focus(M),n=!0):N===u&&((s=c(d).pop())&&l.let(s.title),l.focus(),n=!0):E&&P===u&&((s=c(d).pop())&&s.focus(M),n=!0);n&&O(t)}function ot(){Q=!1}function ct(){var t=this,e=t["_"+V],n=e._mask,r=e.state,s=n.hint;D((function(){var n=m(t);null!==n&&n.split(r.join).forEach((function(t){return e.set(t)})),R(t,""),R(s,e.self.placeholder)}),1)()}function ft(t){var e=this,n=e["_"+V],r=n._tags,s=n.state.class+"__tag--focus";if(C(e,s),Q);else{Z();var i=2===t.button,u=0;for(var a in r)k(r[a],s)&&++u,e===r[a]||i||x(r[a],s);u>0&&A(e,s)}k(e,s)?($(e),F(h(e))):Z(),O(t),function(t){t&&t.stopPropagation()}(t)}function lt(t){var e=d(this),n=e["_"+V];n._mask.input,T("click",this,lt),n.let(e.title),n.focus(),O(t)}return J.attach=function(n,u){var o=this;n=n||o.self,u=u||o.state,o._active=!0,o._tags={},o._value=function(t){return t.value.replace(/\r/g,"")}(n),o.self=n,o.state=u;var c=u.class,f="_"+V;g(n);var l=S("div",{class:c,tabindex:!z(n)&&-1});o.mask=l;var v,p,h=S("span",{class:c+"__tags"}),m=S("span",{class:c+"__text"}),k=S("span",{contenteditable:!z(n)&&"true",spellcheck:"false",style:"white-space:pre;"}),y=S("span",n.placeholder+"");E(l,h),E(h,m),E(m,k),E(m,y),A(n,c+"__self"),p=l,d(v=n).insertBefore(p,_(v,!0)),q("blur",k,X),q("focus",n,rt),q("focus",k,nt),q("keydown",k,at),q("keyup",k,ot),q("paste",k,ct),n.tabIndex=-1,l[f]=o,k[f]=o;var b={};if(b.hint=y,b.input=k,b.of=n,b.self=l,b.tags=h,b.text=m,o._mask=b,s(u)&&t(u.with))for(var x=0,w=a(u.with);x<w;++x){var j=u.with[x];i(j)&&(j=G[j]),e(j)?j.call(o,n,u):r(j)&&e(j.attach)&&j.attach.call(o,n,u)}return o},J.blur=function(){},J.click=function(){},J.detach=function(){var n=this,s=n._mask,u=n.mask,o=n.self,c=n.state,f=s.input;if(n._active=!1,T("blur",f,X),T("focus",f,nt),T("focus",o,rt),T("keydown",f,at),T("keyup",f,ot),T("paste",f,ct),t(c.with))for(var l=0,v=a(c.with);l<v;++l){var p=c.with[l];i(p)&&(p=G[p]),r(p)&&e(p.detach)&&p.detach.call(n,o,c)}return o.tabIndex=null,x(o,c.class+"__self"),w(u),n._mask={of:o},n.mask=null,n},J.focus=function(){var t=this._mask.input;return t&&($(t),F(t)),this},J.get=function(t){var e=this._active,n=this._tags;return!!e&&(n[t]?t:null)},J.let=function(t){var e=this,n=e._active,r=e._tags,s=e.self,i=e.state;if(!n)return e;if(!r[t])return!1;var u=r[t],a=h(u);return T("blur",u,U),T("contextmenu",u,Y),T("copy",u,tt),T("cut",u,et),T("focus",u,st),T("keydown",u,it),T("keyup",u,ut),T("mousedown",u,ft),T("mousedown",a,lt),T("touchstart",u,ft),T("touchstart",a,lt),w(u),delete e._tags[t],s.value=o(e._tags).join(i.join),e},J.set=function(t){var n=this,r=n._active,s=n._filter,u=n._mask,a=n._tags,c=n.self,f=n.state,l=u.text,v=f.pattern,p=f.class;if(!r)return n;if(e(s)&&(t=s.call(n,t)),i(v)&&K(v)&&!K(v).test(t))return!1;if(""===t||a[t])return!1;var h,_,g=S("span",{class:p+="__tag",tabindex:-1,title:t}),m=S("span",t),k=S("span",{class:p+="-x",tabindex:-1});return q("blur",g,U),q("contextmenu",g,Y),q("copy",g,tt),q("cut",g,et),q("focus",g,st),q("keydown",g,it),q("keyup",g,ut),q("mousedown",g,ft),q("mousedown",k,lt),q("touchstart",g,ft),q("touchstart",k,lt),g["_"+V]=n,E(g,m),E(g,k),_=g,d(h=l).insertBefore(_,h),n._tags[t]=g,c.value=o(n._tags).join(f.join),n},G}));