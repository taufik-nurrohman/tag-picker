/*!
 *
 * The MIT License (MIT)
 *
 * Copyright © 2024 Taufik Nurrohman <https://github.com/taufik-nurrohman>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the “Software”), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).TagPicker=e()}(this,(function(){"use strict";var t=function(t){return Array.isArray(t)},e=function(t){return"function"==typeof t},n=function(t,e){return t&&a(e)&&t instanceof e},s=function(t,e){return void 0===e&&(e=!0),"object"==typeof t&&(!e||n(t,Object))},a=function(t){return function(t){return void 0!==t}(t)&&!function(t){return null===t}(t)},r=function(t){return"string"==typeof t},u=function(t){return t.toLowerCase()},i=function(t){return t.length},o=function(t){return Object.keys(t)},c=function(t){return Object.values(t)},f=function e(){for(var n=arguments.length,r=Array(n),u=0;u<n;u++)r[u]=arguments[u];for(var o,c=r.shift(),f=0,l=i(r);f<l;++f)for(var v in r[f])if(a(c[v]))if(t(c[v])&&t(r[f][v])){c[v]=[].concat(c[v]);for(var p=0,_=i(r[f][v]);p<_;++p)o=r[f][v][p],-1===c[v].indexOf(o)&&c[v].push(r[f][v][p])}else s(c[v])&&s(r[f][v])?c[v]=e({},c[v],r[f][v]):c[v]=r[f][v];else c[v]=r[f][v];return c},l=function e(n){if(t(n))return n.map((function(t){return e(n)}));if(s(n)){for(var a in n)n[a]=e(n[a]);return n}return!1===n?"false":null===n?"null":!0===n?"true":""+n},v=document,p=window,_=function(t,e){return t["next"+(e?"":"Element")+"Sibling"]||null},h=function(t,e){return e?t.closest(e)||null:t.parentNode||null},m=function(t){var e="form";return k(t,e)&&e===function(t){return u(t&&t.nodeName||"")||null}(t[e])?t[e]:h(t,e)},d=function(t,e){void 0===e&&(e=!0);var n="textContent";if(!k(t,n))return!1;var s=t[n];return""!==(s=e?s.trim():s)?s:null},g=function(t,e){return t.classList.contains(e)},k=function(t,e){return e in t},y=function(t,e){return t.removeAttribute(e),t},b=function(t,e){return t.classList.remove(e),t},w=function(t){var e=h(t);return t.remove(),e},x=function(t,e,n){return!0===n&&(n=e),t.setAttribute(e,l(n)),t},j=function(t,e){return t.append(e),e},E=function(t,e){return t.classList.add(e),t},A=function(t,e,n){return t=r(t)?v.createElement(t):t,s(e)&&(n=e,e=!1),r(e)&&L(t,e),s(n)&&function(t,e){var n;for(var s in e)(n=e[s])||""===n||0===n?x(t,s,n):y(t,s)}(t,n),t},L=function(t,e,n){if(void 0===n&&(n=!0),null===e)return t;var s="innerHTML";return k(t,s)&&(t[s]=n?e.trim():e),t},S=function(t,e,n){if(void 0===n&&(n=!0),null===e)return t;var s="textContent";return k(t,s)&&(t[s]=n?e.trim():e),t};var K=function(t,e,n){e.removeEventListener(t,n)},R=function(t){return t&&t.preventDefault()},C=function(t,e,n,s){void 0===s&&(s=!1),e.addEventListener(t,n,s)},O=function(t,e){return function(t){return n(t,RegExp)}(t)?t:RegExp(t,a(e)?e:"g")},P="ArrowLeft",T="ArrowRight",q="Home",B="Backspace",N="End";function D(t,e){return p.setTimeout(t,1)}function H(t){return t.disabled}function I(t,e){var s=this;return t?n(s,I)?(t["_"+I.name]=function(t,e){return(e=e||t).fire=function(t,e){var n=this,s=n.hooks;return a(s[t])?(s[t].forEach((function(t){return t.apply(n,e)})),n):n},e.off=function(t,e){var n=this,s=n.hooks;if(!a(t))return s={},n;if(a(s[t]))if(a(e)){var r=s[t].length;if(0===r)delete s[t];else for(var u=0;u<r;++u)if(e===s[t][u]){s[t].splice(u,1);break}}else delete s[t];return n},e.on=function(t,e){var n=this.hooks;return a(n[t])||(n[t]=[]),a(e)&&n[t].push(e),this},t.hooks={},t}(s,I.prototype),s.attach(t,f({},I.state,r(e)?{join:e}:e||{}))):new I(t,e):s}I.state={class:"tag-picker",escape:[","],join:", ",max:9999,min:0,pattern:null,with:[]},I.version="4.0.0",Object.defineProperty(I,"name",{value:"TagPicker"});var M=I.prototype;function W(){var t=this["_"+I.name].state;b(this,t.class+"--focus")}function Z(){var t=this["_"+I.name];t._mask;var e=t.mask,n=t.state.class;b(e,n+="--focus"),b(e,n+="-tag")}function $(){var t=this["_"+I.name],e=t._mask,n=t.mask,s=t.state,a=e.text,r=s.class;b(a,r+"__text--focus"),b(n,r+="--focus"),b(n,r+="-text")}function z(t){var e=this["_"+I.name],n=e._mask,s=e._tags,a=e.mask,r=e.state,u=n.copy,o=r.class,c=[];for(var f in s)g(s[f],o+"__tag--selected")&&c.push(f);i(c)&&(a!==h(u)&&(u.value=c.join(r.join),j(a,u)),u.focus(),u.select())}function F(){var t=this,e=t["_"+I.name]._mask.input;D((function(){return w(t),e.focus()}))}function G(){var t=this,e=t["_"+I.name],n=e._mask,s=e.state,a=n.input;t.value.split(s.join).forEach((function(t){return e.let(t)})),D((function(){return w(t),a.focus()}))}function J(){var t=this["_"+I.name],e=t._tags,n=t.mask,s=t.state.class,a=0;for(var r in e)g(e[r],s+"__tag--selected")&&++a;E(n,s+="--focus"),E(n,s+="-tag"+(a>1?"s":""))}function Q(){var t,e,n,s=this["_"+I.name],a=s._mask,r=s._tags,u=s.mask,i=s.self,o=s.state,c=a.copy,f=a.hint,l=a.input,_=a.text,h=o.class;for(var m in r)b(r[m],h+"__tag--selected");b(u,h+"--focus-tag"),b(u,h+"--focus-tags"),w(c),E(_,h+"__text--focus"),E(u,h+="--focus"),E(u,h+="-text"),t=l,(n=v.createRange()).selectNodeContents(t),n.collapse(!1),(e=p.getSelection()).removeAllRanges(),e.addRange(n),D((function(){return S(f,d(l)?"":i.placeholder)}))}function U(){this["_"+I.name].focus()}function V(){var t=this["_"+I.name].state;E(this,t.class+"--focus")}function X(){var t=this["_"+I.name];t._mask;var e=t.mask,n=t.state.class;E(e,n+="--focus"),g(e,n+"-tags")||E(e,n+="-tag")}M._filter=function(t){var e,n,s=this.state;return t=(t||"").split(s.join).join("").trim(),(e=t,void 0===n&&(n="-"),e.replace(/[A-Z]/g,(function(t){return n+u(t)})).replace(/\W+/g,n)).replace(/^-+|-+$/g,"")};var Y=!1;function tt(t){Y=t.ctrlKey,t.shiftKey}function et(t){var e,n,s,a=this,r=t.key,u=t.ctrlKey,i=t.shiftKey,o=a["_"+I.name],f=o._mask,l=o._tags,v=o.mask,p=o.state,h=f.copy,m=f.text,d=a.previousElementSibling||null,g=_(a),k=p.class;if(u){if(!i&&"a"===r){for(var y in l)E(l[y],k+"__tag--selected");h.value=o.value,j(v,h),h.focus(),h.select(),e=!0}}else b(a,k+"__tag--selected"),q===r?((n=c(l).shift())&&n.focus(),e=!0):N===r?((s=c(l).pop())&&s.focus(),e=!0):P===r?(d&&d.focus(),e=!0):T===r?(g&&m!==g?g.focus():o.focus(),e=!0):B===r?(o.let(a.title),d?d.focus():o.focus(),e=!0):"Delete"===r&&(o.let(a.title),g&&m!==g?g.focus():o.focus(),e=!0);e&&R(t)}function nt(t){var e=t.key,n=t.ctrlKey;t.shiftKey;var s=this["_"+I.name],a=s._mask,r=s._tags,u=s.state,i=a.copy,o=a.input,f=u.class;function l(){for(var t in w(i),r)b(r[t],f+"__tag--selected")}n||(q===e||P===e?(l(),c(r).shift().focus()):N===e||T===e?(l(),c(r).pop().focus()):"Escape"===e?(l(),o.focus()):(this.value.split(u.join).forEach((function(t){return s.let(t)})),o.focus()))}function st(t){var n,s,a,r,u=this,i=t.key,o=t.keyCode,f=t.ctrlKey,l=t.shiftKey,_=u["_"+I.name],h=_._mask,g=_._tags,k=_.mask,y=_.self,b=_.state,w=h.copy,x=h.hint,A=b.class;if((escape=b.escape).includes(i)||escape.includes(o))return _.set(function(t){return d(t)}(u)),S(u,""),S(x,y.placeholder),_.focus(),R(t);D((function(){return S(x,d(u)?"":y.placeholder)}));var L,K=""===function(t){var e,n=p.getSelection();if(n.rangeCount>0)return(e=n.getRangeAt(0).cloneRange()).collapse(!0),e.setStart(t,0),(e+"").slice(-1)}(u),C=null===d(u);if(q===i&&(f||C))(a=c(g).shift())&&a.focus(),n=!0;else if(N===i&&(f||C))(r=c(g).pop())&&r.focus(),n=!0;else if(P===i&&(f||K))(r=c(g).pop())&&r.focus(),n=!0;else if(B===i&&C)(r=c(g).pop())&&_.let(r.title),_.focus(),n=!0;else if("Enter"===i){var O=m(y);if(O&&e(O.requestSubmit)){var T=(L="button:not([type]),button[type=submit],input[type=image],input[type=submit]",(O||v).querySelector(L));T?O.requestSubmit(T):O.requestSubmit()}n=!0}else if(f&&!l&&"a"===i&&null===d(u)&&null!==(s=_.value)){for(var H in g)E(g[H],A+"__tag--selected");w.value=s,j(k,w),w.focus(),w.select(),n=!0}n&&R(t)}function at(){var t=this["_"+I.name],e=t._mask,n=t._tags,s=t.mask,a=t.state,r=e.copy,u=a.class;Y=!1;var o=[];for(var c in n)g(n[c],u+"__tag--selected")&&o.push(c);i(o)>1&&(r.value=o.join(a.join),j(s,r),r.focus(),r.select())}function rt(){var t=this,e=t.value,n=t["_"+I.name],s=n._mask,a=n.state,r=s.copy,u=s.input;D((function(){""!==e&&e.split(a.join).forEach((function(t){return n.let(t)})),""!==(e=t.value)&&e.split(a.join).forEach((function(t){return n.set(t)})),w(r),u.focus()}))}function ut(){var t=this,e=t["_"+I.name],n=e._mask,s=e.state,a=n.hint;D((function(){var n=d(t);null!==n&&n.split(s.join).forEach((function(t){return e.set(t)})),S(t,""),S(a,e.self.placeholder)}))}function it(t){var e=this["_"+I.name],n=e._mask,s=e._tags,a=e.mask,r=e.state,u=n.copy,i=n.input,o=r.class;if(a===h(u))if(i===t.target){var c=0;for(var f in s)g(s[f],o+"__tag--selected")&&++c;c<2&&i.focus()}else u.focus(),u.select();else i.focus();R(t)}function ot(t){var e,n,s=this,a=s["_"+I.name],r=a._mask,u=a._tags,i=a.mask,o=a.state,c=r.copy,f=o.class+"__tag--selected",l=i===h(c),v=0;if(!Y){for(var p in u)g(u[p],f)&&++v,s!==u[p]&&(l||b(u[p],f));w(c)}if(l&&v>1)E(s,f);else if(e=f,s.classList.toggle(e,n),Y){for(var _ in v=0,u)g(u[_],f)&&++v;f=o.class+"--focus-tag",b(i,f),b(i,f+"s"),v>0&&E(i,f+(v>1?"s":""))}!function(t){t&&t.stopPropagation()}(t)}function ct(t){var e=h(this),n=e["_"+I.name],s=n._mask.input;K("click",this,ct),n.let(e.title),s.focus(),R(t)}return M.attach=function(n,u){var o=this;n=n||o.self,u=u||o.state,o._active=!0,o._tags={},o._value=function(t){return t.value.replace(/\r/g,"")}(n),o.self=n,o.state=u;var c=u.class,f="_"+I.name;m(n);var l=A("div",{class:c,tabindex:!H(n)&&-1});o.mask=l;var v,p,d=A("span",{class:c+"__tags"}),g=A("span",{class:c+"__text"}),k=A("input",{class:c+"__copy",tabindex:-1,type:"text"}),y=A("span",{contenteditable:!H(n)&&"true",spellcheck:"false",style:"white-space:pre;"}),b=A("span",n.placeholder+"");j(l,d),j(d,g),j(g,y),j(g,b),E(n,c+"__self"),p=l,h(v=n).insertBefore(p,_(v,!0)),C("blur",l,W),C("blur",y,$),C("contextmenu",l,z),C("copy",k,F),C("cut",k,G),C("focus",l,V),C("focus",n,U),C("focus",k,J),C("focus",y,Q),C("keydown",l,tt),C("keydown",k,nt),C("keydown",y,st),C("keyup",l,at),C("mousedown",l,it),C("paste",k,rt),C("paste",y,ut),C("touchstart",l,it),n.tabIndex=-1,l[f]=o,k[f]=o,y[f]=o;var w={};if(w.copy=k,w.hint=b,w.input=y,w.of=n,w.self=l,w.tags=d,w.text=g,o._mask=w,a(u)&&t(u.with))for(var x=0,L=i(u.with);x<L;++x){var S=u.with[x];r(S)&&(S=I[S]),e(S)?S.call(o,n,u):s(S)&&e(S.attach)&&S.attach.call(o,n,u)}return o},M.blur=function(){},M.click=function(){},M.detach=function(){var n=this,a=n._mask,u=n.mask,o=n.self,c=n.state,f=a.copy,l=a.input;if(n._active=!1,K("blur",l,$),K("blur",u,W),K("contextmenu",u,z),K("copy",f,F),K("cut",f,G),K("focus",f,J),K("focus",l,Q),K("focus",u,V),K("focus",o,U),K("keydown",f,nt),K("keydown",l,st),K("keydown",u,tt),K("keydown",u,at),K("mousedown",u,it),K("paste",f,rt),K("paste",l,ut),K("touchstart",u,it),t(c.with))for(var v=0,p=i(c.with);v<p;++v){var _=c.with[v];r(_)&&(_=I[_]),s(_)&&e(_.detach)&&_.detach.call(n,o,c)}return o.tabIndex=null,b(o,c.class+"__self"),w(u),n._mask={of:o},n.mask=null,n},M.focus=function(){var t=this._mask.input;return t&&t.focus(),this},M.get=function(t){var e=this._active,n=this._tags;return!!e&&(n[t]?t:null)},M.let=function(t){var e=this,n=e._active,s=e._tags,a=e.self,r=e.state;if(!n)return e;if(!s[t])return!1;var u=s[t],i=u.firstElementChild||null;return K("blur",u,Z),K("focus",u,X),K("keydown",u,et),K("mousedown",u,ot),K("mousedown",i,ct),K("touchstart",u,ot),K("touchstart",i,ct),w(u),delete e._tags[t],a.value=o(e._tags).join(r.join),e},M.set=function(t){var n=this,s=n._active,a=n._filter,u=n._mask,i=n._tags,c=n.self,f=n.state,l=u.text,v=f.pattern,p=f.class;if(!s)return n;if(e(a)&&(t=a.call(n,t)),r(v)&&O(v)&&!O(v).test(t))return!1;if(""===t||i[t])return!1;var _,m,d=A("span",{class:p+="__tag",tabindex:-1,title:t}),g=A("span",{class:p+="-x",tabindex:-1});return C("blur",d,Z),C("focus",d,X),C("keydown",d,et),C("mousedown",d,ot),C("mousedown",g,ct),C("touchstart",d,ot),C("touchstart",g,ct),d["_"+I.name]=n,j(d,g),m=d,h(_=l).insertBefore(m,_),n._tags[t]=d,c.value=o(n._tags).join(f.join),n},Object.defineProperty(M,"tags",{get:function(){return o(this._tags)},set:function(t){var e=this,n=e.self,s=e.set;e._tags={},n.value="",t.forEach((function(t){return s(t)}))}}),Object.defineProperty(M,"value",{get:function(){var t=this.self.value;return""===t?null:t},set:function(t){this.self.value=t}}),I}));